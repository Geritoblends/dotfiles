#!/bin/bash

# Usage: theme <colorscheme> [layout_name]
# Example: theme nord minimal
# Example: theme gruvbox (defaults to 'default' layout)

COLOR_THEME="$1"
LAYOUT_STYLE="$2"


# ---------------------------------------------------------
# 1. PATH DEFINITIONS
# ---------------------------------------------------------
# The Repository (Source of Truth)
DOTS_DIR="$HOME/nix-dots"
SCHEME_SOURCE="$DOTS_DIR/config/wal/colorschemes"
TEMPLATE_SOURCE="$DOTS_DIR/config/wal/templates"
LAYOUTS_ROOT="$DOTS_DIR/layouts"

# Local Pywal Locations
WAL_CONFIG_DIR="$HOME/.config/wal"
WAL_TEMPLATE_DIR="$WAL_CONFIG_DIR/templates"
WAL_SCHEME_DIR="$WAL_CONFIG_DIR/colorschemes"
CACHE_DIR="$HOME/.cache/wal"

# Target Config Files (Local System)
HYPR_CONF="$HOME/.config/hypr/layout-settings.conf"
WAYBAR_CONF="$HOME/.config/waybar/config.jsonc"
WAYBAR_STYLE="$HOME/.config/waybar/style.css"
FUZZEL_CONF="$HOME/.config/fuzzel/fuzzel.ini"
DUNST_CONF="$HOME/.config/dunst/dunstrc"
FOOT_CONF="$HOME/.config/foot/foot.ini"

# ---------------------------------------------------------
# 2. VALIDATION & DEFAULTS
# ---------------------------------------------------------
if [ -z "$COLOR_THEME" ]; then
    echo "ðŸŽ¨ Available Colors:"
    ls "$SCHEME_SOURCE" 2>/dev/null | sed 's/.json//' | tr '\n' ' '
    echo -e "\n\nðŸ“ Available Layouts:"
    ls "$LAYOUTS_ROOT" 2>/dev/null | tr '\n' ' '
    echo ""
    exit 1
fi

# Default layout to "default" if not specified
if [ -z "$LAYOUT_STYLE" ]; then
    LAYOUT_STYLE="mono-minimal"
fi

LAYOUT_DIR="$LAYOUTS_ROOT/$LAYOUT_STYLE"

# Validate Inputs
if [ ! -f "$SCHEME_SOURCE/$COLOR_THEME.json" ]; then
    echo "âŒ Error: Color scheme '$COLOR_THEME' not found."
    exit 1
fi

if [ ! -d "$LAYOUT_DIR" ]; then
    echo "âŒ Error: Layout '$LAYOUT_STYLE' not found in $LAYOUTS_ROOT"
    exit 1
fi

# ---------------------------------------------------------
# 3. PREPARE PYWAL (The Hybrid Approach)
# ---------------------------------------------------------
echo "âš™ï¸  Preparing Pywal..."

# Ensure local directories exist
mkdir -p "$WAL_TEMPLATE_DIR"
mkdir -p "$WAL_SCHEME_DIR"

# A. Link Static Schemes (Repo -> Local)
# We link the folder so new schemes added to repo appear automatically
if [ ! -L "$WAL_SCHEME_DIR" ]; then
    rm -rf "$WAL_SCHEME_DIR"
    ln -sf "$SCHEME_SOURCE" "$WAL_SCHEME_DIR"
fi

# B. Link Static Templates (Repo -> Local)
# We link the contents so we can inject files alongside them
ln -sf "$TEMPLATE_SOURCE/"* "$WAL_TEMPLATE_DIR/"

# C. Inject Dynamic Layout Template (Layout -> Local)
# We COPY the dunstrc because it changes based on the layout choice.
# This prevents git dirty states and allows 'wal' to merge it.
if [ -f "$LAYOUT_DIR/dunstrc" ]; then
    cp "$LAYOUT_DIR/dunstrc" "$WAL_TEMPLATE_DIR/dunstrc"
else
    echo "âš ï¸  Warning: No dunstrc found in layout '$LAYOUT_STYLE'"
fi

# ---------------------------------------------------------
# 4. GENERATE COLORS
# ---------------------------------------------------------
echo "ðŸŽ¨ Applying Colors ($COLOR_THEME)..."

# This generates ~/.cache/wal/colors-hyprland.conf, ~/.cache/wal/dunstrc, etc.
wal -f "$SCHEME_SOURCE/$COLOR_THEME.json" > /dev/null

# Save current theme name for other scripts
echo "$COLOR_THEME" > "$CACHE_DIR/current_theme_name"

# ---------------------------------------------------------
# 5. UPDATE ACTIVE APPLICATIONS
# ---------------------------------------------------------

echo "ðŸ¦Š Updating Firefox..."
pywalfox update

echo "ðŸ“ Updating all active Neovim sessions..."

if command -v nvr &> /dev/null; then
    NVIM_CMD=":colorscheme wal<CR>"

    # Loop through all found sockets and update them one by one
    for socket in /tmp/nvim.*.0; do
        # Check if the socket actually exists (avoids errors if no nvim is running)
        if [ -S "$socket" ]; then
            nvr --servername "$socket" --remote-send "$NVIM_CMD" &
        fi
    done
else
    echo "Warning: nvim-remote (nvr) not found."
fi

# ---------------------------------------------------------
# 6. LINK LAYOUT FILES (System -> Repo)
# ---------------------------------------------------------
echo "ðŸ“ Linking Layout ($LAYOUT_STYLE)..."

# Helper function
link_file() {
    src="$1"
    dest="$2"
    mkdir -p "$(dirname "$dest")" # Ensure parent dir exists
    
    if [ -f "$src" ]; then
        ln -sf "$src" "$dest"
    else
        echo "âš ï¸  Missing layout file: $src"
    fi
}

# Hyprland (Partial Config)
link_file "$LAYOUT_DIR/hypr-layout.conf" "$HYPR_CONF"

# Waybar (Config + Style)
link_file "$LAYOUT_DIR/waybar/config.jsonc" "$WAYBAR_CONF"
link_file "$LAYOUT_DIR/waybar/style.css" "$WAYBAR_STYLE"

# Fuzzel (Config)
link_file "$LAYOUT_DIR/fuzzel.ini" "$FUZZEL_CONF"

# Foot (Config)
link_file "$LAYOUT_DIR/foot.ini" "$FOOT_CONF"
# Dunst (Special Case: Link to Cache)
# We don't link to the layout folder. We link to the generated cache file.
mkdir -p "$(dirname "$DUNST_CONF")"
ln -sf "$CACHE_DIR/dunstrc" "$DUNST_CONF"

# ---------------------------------------------------------
# 7. WALLPAPER HANDLING (Prioritize 'main.*', then fallback)
# ---------------------------------------------------------

WALL_DIR="$HOME/Pictures/Wallpapers/$COLOR_THEME"
if [ ! -d "$WALL_DIR" ]; then
    mkdir -p "$WALL_DIR"
fi
echo "WALLPAPER_DIR=\"$WALL_DIR\"" > "$CACHE_DIR/wallpaper_env.sh"

# 1. Priority: Look for a wallpaper named 'main' (e.g., main.jpg, main.png)
TARGET_WALL=$(find "$WALL_DIR" -maxdepth 1 -type f -name "main.*" \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" -o -iname "*.gif" \) | head -n 1)

# 2. Fallback: If no 'main.*' found, grab the first available image
if [ -z "$TARGET_WALL" ]; then
    TARGET_WALL=$(find "$WALL_DIR" -maxdepth 1 -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" -o -iname "*.gif" \) | head -n 1)
fi

# Apply the wallpaper if found
if [ -n "$TARGET_WALL" ]; then
    echo "ðŸ–¼ï¸  Setting wallpaper: $(basename "$TARGET_WALL")"
    
    # A. Update swww (live)
    swww img "$TARGET_WALL" --transition-type none

    # B. Update configs for persistence (Hyprpaper & Hyprlock)
    HYPAPER_CONFIG="$HOME/.config/hypr/hyprpaper.conf"
    HYPRLOCK_CONFIG="$HOME/.config/hypr/hyprlock.conf"

    if [ -f "$HYPAPER_CONFIG" ]; then
        sed -i "s|^preload = .*|preload = $TARGET_WALL|" "$HYPAPER_CONFIG"
        sed -i "s|^wallpaper = .*|wallpaper = ,$TARGET_WALL|" "$HYPAPER_CONFIG"
    fi

    if [ -f "$HYPRLOCK_CONFIG" ]; then
        sed -i "s|^\$wallpaper = .*|\$wallpaper = $TARGET_WALL|" "$HYPRLOCK_CONFIG"
    fi
else
    echo "âš ï¸  No wallpapers found in $WALL_DIR"
fi

# ---------------------------------------------------------
# 8. RELOAD APPLICATIONS
# ---------------------------------------------------------
echo "ðŸ”„ Reloading apps..."

# Hyprland
hyprctl reload > /dev/null

# Waybar
pkill waybar
waybar & disown

# Nautilus
killall nautilus

# Dunst (Needs a moment to die completely)
pkill dunst
sleep 0.2
dunst & disown

# Fuzzel (Reads config on launch, no reload needed)

echo "âœ… System transitioned to [$COLOR_THEME] :: [$LAYOUT_STYLE]"
