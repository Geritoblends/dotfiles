#!/bin/bash

# Usage: theme -c <colorscheme> -l <layout>

# ---------------------------------------------------------
# 1. PATH DEFINITIONS
# ---------------------------------------------------------
DOTS_DIR="$HOME/nix-dots"
SCHEME_SOURCE="$DOTS_DIR/config/wal/colorschemes"
TEMPLATE_SOURCE="$DOTS_DIR/config/wal/templates"
LAYOUTS_ROOT="$DOTS_DIR/layouts"

# Local Pywal Locations
WAL_CONFIG_DIR="$HOME/.config/wal"
WAL_TEMPLATE_DIR="$WAL_CONFIG_DIR/templates"
WAL_SCHEME_DIR="$WAL_CONFIG_DIR/colorschemes"
CACHE_DIR="$HOME/.cache/wal"
mkdir -p "$CACHE_DIR"

# State Files
CURRENT_THEME_FILE="$CACHE_DIR/current_theme_name"
CURRENT_LAYOUT_FILE="$CACHE_DIR/current_layout"

# Target Config Files
HYPR_CONF="$HOME/.config/hypr/layout-settings.conf"
WAYBAR_CONF="$HOME/.config/waybar/config.jsonc"
WAYBAR_STYLE="$HOME/.config/waybar/style.css"
FUZZEL_CONF="$HOME/.config/fuzzel/fuzzel.ini"
DUNST_CONF="$HOME/.config/dunst/dunstrc"
FOOT_CONF="$HOME/.config/foot/foot.ini"

# ---------------------------------------------------------
# 2. ARGUMENT PARSING
# ---------------------------------------------------------

TARGET_COLOR=""
TARGET_LAYOUT=""

show_help() {
    echo "Usage: theme [-c colorscheme] [-l layout]"
    echo ""
    echo "ðŸŽ¨ Available Colors:"
    ls "$SCHEME_SOURCE" 2>/dev/null | sed 's/.json//' | tr '\n' ' '
    exit 1
}

while getopts "c:l:h" opt; do
  case $opt in
    c) TARGET_COLOR="$OPTARG" ;;
    l) TARGET_LAYOUT="$OPTARG" ;;
    h) show_help ;;
    *) show_help ;;
  esac
done

# ---------------------------------------------------------
# 3. STATE RESOLUTION
# ---------------------------------------------------------

# A. Resolve Layout (Default to current if missing)
if [ -z "$TARGET_LAYOUT" ]; then
    if [ -f "$CURRENT_LAYOUT_FILE" ]; then
        TARGET_LAYOUT=$(cat "$CURRENT_LAYOUT_FILE")
    else
        TARGET_LAYOUT="mono-minimal"
    fi
    echo "â„¹ï¸  Keeping current layout: $TARGET_LAYOUT"
fi

LAYOUT_DIR="$LAYOUTS_ROOT/$TARGET_LAYOUT"

# Validate Inputs
if [ -n "$TARGET_COLOR" ] && [ ! -f "$SCHEME_SOURCE/$TARGET_COLOR.json" ]; then
    echo "âŒ Error: Color scheme '$TARGET_COLOR' not found."
    exit 1
fi

if [ ! -d "$LAYOUT_DIR" ]; then
    echo "âŒ Error: Layout '$TARGET_LAYOUT' not found."
    exit 1
fi

# ---------------------------------------------------------
# 4. PREPARE TEMPLATES (Layout Switch)
# ---------------------------------------------------------
echo "âš™ï¸  Preparing Pywal templates for $TARGET_LAYOUT..."
mkdir -p "$WAL_TEMPLATE_DIR" "$WAL_SCHEME_DIR"

if [ ! -L "$WAL_SCHEME_DIR" ]; then
    rm -rf "$WAL_SCHEME_DIR"
    ln -sf "$SCHEME_SOURCE" "$WAL_SCHEME_DIR"
fi
ln -sf "$TEMPLATE_SOURCE/"* "$WAL_TEMPLATE_DIR/"

# Inject Layout-specific Dunst config
if [ -f "$LAYOUT_DIR/dunstrc" ]; then
    cp "$LAYOUT_DIR/dunstrc" "$WAL_TEMPLATE_DIR/dunstrc"
else
    echo "âš ï¸  Warning: No dunstrc found in layout."
fi

# ---------------------------------------------------------
# 5. GENERATE COLORS (The Critical Fix)
# ---------------------------------------------------------

if [ -n "$TARGET_COLOR" ]; then
    # CASE A: User explicitly requested a new color theme.
    # We overwrite everything (Music Mood / Old Theme).
    echo "ðŸŽ¨ Applying New Colors: $TARGET_COLOR"
    wal -f "$SCHEME_SOURCE/$TARGET_COLOR.json" > /dev/null
    
    # Save this as the new "Default" for when music stops
    echo "$TARGET_COLOR" > "$CURRENT_THEME_FILE"
    
    # Handle Wallpaper Update
    WALL_DIR="$HOME/Pictures/Wallpapers/$TARGET_COLOR"
    mkdir -p "$WALL_DIR"
    echo "WALLPAPER_DIR=\"$WALL_DIR\"" > "$CACHE_DIR/wallpaper_env.sh"

    TARGET_WALL=$(find "$WALL_DIR" -maxdepth 1 -type f -name "main.*" | head -n 1)
    [ -z "$TARGET_WALL" ] && TARGET_WALL=$(find "$WALL_DIR" -maxdepth 1 -type f | head -n 1)

    if [ -n "$TARGET_WALL" ]; then
        echo "ðŸ–¼ï¸  Setting wallpaper: $(basename "$TARGET_WALL")"
        if command -v swww &> /dev/null; then
            swww img "$TARGET_WALL" --transition-type none
        fi
        # Update Persistence
        HYPAPER_CONFIG="$HOME/.config/hypr/hyprpaper.conf"
        HYPRLOCK_CONFIG="$HOME/.config/hypr/hyprlock.conf"
        [ -f "$HYPAPER_CONFIG" ] && sed -i "s|^preload = .*|preload = $TARGET_WALL|" "$HYPAPER_CONFIG"
        [ -f "$HYPAPER_CONFIG" ] && sed -i "s|^wallpaper = .*|wallpaper = ,$TARGET_WALL|" "$HYPAPER_CONFIG"
        [ -f "$HYPRLOCK_CONFIG" ] && sed -i "s|^\$wallpaper = .*|\$wallpaper = $TARGET_WALL|" "$HYPRLOCK_CONFIG"
    fi

else
    # CASE B: Layout Change Only.
    # We MUST NOT change the colors. We just need to re-generate the templates
    # (like dunstrc) using whatever colors are CURRENTLY active (Music or Theme).
    echo "ðŸŽ¨ Preserving current colors (wal -R)..."
    wal -R -n -t -q
fi

# Save Layout State
echo "$TARGET_LAYOUT" > "$CURRENT_LAYOUT_FILE"

# ---------------------------------------------------------
# 6. RELOAD & LINK
# ---------------------------------------------------------

echo "ðŸ¦Š Updating Firefox..."
if command -v pywalfox &> /dev/null; then pywalfox update; fi

echo "ðŸ“ Updating Neovim..."
if command -v nvr &> /dev/null; then
    for socket in /tmp/nvim.*.0; do
        [ -S "$socket" ] && nvr --servername "$socket" --remote-send ":colorscheme wal<CR>" &
    done
fi

echo "ðŸ“ Linking Layout Files..."
link_file() {
    src="$1"; dest="$2"
    mkdir -p "$(dirname "$dest")"
    [ -f "$src" ] && ln -sf "$src" "$dest"
}

link_file "$LAYOUT_DIR/hypr-layout.conf" "$HYPR_CONF"
link_file "$LAYOUT_DIR/waybar/config.jsonc" "$WAYBAR_CONF"
link_file "$LAYOUT_DIR/waybar/style.css" "$WAYBAR_STYLE"
link_file "$LAYOUT_DIR/fuzzel.ini" "$FUZZEL_CONF"
link_file "$LAYOUT_DIR/foot.ini" "$FOOT_CONF"
mkdir -p "$(dirname "$DUNST_CONF")"
ln -sf "$CACHE_DIR/dunstrc" "$DUNST_CONF"

echo "ðŸ”„ Reloading apps..."
hyprctl reload > /dev/null
pkill waybar; waybar & disown
killall nautilus 2>/dev/null
pkill dunst; sleep 0.2; dunst & disown

echo "âœ… Done."
