#!/bin/bash

if [ "$#" -eq 0 ]; then
    echo "Usage: mfetch \"Song Title - Artist Name [- Album Name]\" ..."
    exit 1
fi

music_dir="$HOME/Music"

if ! command -v mpc &> /dev/null; then
    echo "âš ï¸ Warning: 'mpc' command not found. Skipping playlist update." >&2
fi

for query in "$@"; do
    filename="${query}.mp3"

    echo "ï€ Downloading: ${query}..."

    # Download the audio
    yt-dlp "ytsearch1:${query}" \
        --ffmpeg-location "$(which ffmpeg)" \
        --quiet \
        --no-warnings \
        --extract-audio \
        --audio-format mp3 \
        --output "${music_dir}/${filename}" \
        --no-playlist
    
    # --- Parsing Logic (Same) ---
    title=$(echo "$query" | cut -d '-' -f1 | xargs)
    rest=$(echo "$query" | cut -d '-' -f2- | xargs)

    if [[ "$rest" == *"-"* ]]; then
        artist=$(echo "$rest" | cut -d '-' -f1 | xargs)
        album=$(echo "$rest" | cut -d '-' -f2- | xargs)
    else
        artist="$rest"
        album=""
    fi

    # --- Tagging Logic (Same) ---
    
    echo "   ðŸ·ï¸ Tagging: Title: $title | Artist: $artist | Album: ${album:-N/A}"
    
    tag_options=(--title="$title" --artist="$artist")
    if [ -n "$album" ]; then
        tag_options+=(--album="$album")
    fi
    eyeD3 "${tag_options[@]}" "${music_dir}/${filename}" > /dev/null

    # --- NEW: Non-Destructive MPD Playlist Logic ---
    if [ -n "$album" ] && command -v mpc &> /dev/null; then
        # 1. Update MPD database to recognize the new file
        mpc update --wait 
        
        # We need the relative path MPD uses
        relative_path="${filename}" 

        # 2. Add the file directly to the SAVED playlist.
        # This command creates the playlist if it doesn't exist AND
        # adds the file to it without touching the current playback queue.
        mpc addplaylist "$album" "$relative_path"
        
        echo "   ðŸŽ¶ Playlist: Added '${title}' to MPD playlist: '${album}' without disrupting playback."
    fi

    notify-send "âœ… Download complete" "'${filename}' saved to Music and tagged."
done
